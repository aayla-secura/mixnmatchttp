<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<script src="/js/allfuncs.js" charset="utf-8"></script>
		<script charset="utf-8">
			window.requestsLeft = 15; // x2 per GET, x1 per POST
			registerWinOnLoad(function () {
				var reqOrigin = getPar("reqOrigin");
				var currOrigin = getCurrOrigin();
				var loggedIn = Boolean(reqOrigin);
				if (! loggedIn) {
					// not the callback from login
					reqOrigin = getReqOrigin();
					if (! reqOrigin || reqOrigin == currOrigin) {
						if (! reqOrigin) {
							logToPage('Cannot determine target origin! Give the target host');
						} else {
							logToPage('Target is the same as current origin! Give a different one');
						}
						document.getElementById('i_reqHost').value = window.location.host; // default to current
						document.getElementById('setVars').style = "";
						return;
					}

					logToConsole('Target origin is ' + reqOrigin);
					logToConsole('Current origin is ' + currOrigin);

					// Login to target
					logToConsole('Logging in to target');
					// keep URL parameters except for host, hostname and port
					var origPars = filterPars(['host', 'hostname', 'port']);
					var callbackUrl = currOrigin + window.location.pathname +
						'?reqOrigin=' + reqOrigin + (origPars ? '&' + origPars : '');
					window.location.replace(reqOrigin + '/login?goto=' +
						encodeURIComponent(callbackUrl));
				}

				var target = reqOrigin + '/secret/secret.txt';
				logToPage('Target is ' + target);

				function getLoadURL(origin, creds, post) {
					return 'getData.html?reqURL=' + encodeURIComponent(target +
						'?origin=' + origin +
						'&creds=' +
						(creds ? '1' : '0')) +
						'&post=' + (post ? '1' : '0');
				};

				var frameStyle = 'width: 100%; height: 5em; border: none;';
				// create iFrames for all combinations of CORS headers
				// GET
				addElement('iframe',{style: frameStyle, src: getLoadURL('*', true, false)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('*', false, false)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('%%ECHO%%', true, false)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('%%ECHO%%', false, false)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('', false, false)});
				// POST
				addElement('iframe',{style: frameStyle, src: getLoadURL('*', true, true)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('*', false, true)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('%%ECHO%%', true, true)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('%%ECHO%%', false, true)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('', false, true)});
			});
		</script>
	</head>
	<body>
		<div id="log" style="margin-top: 20px; margin-bottom: 20px"></div>
		<form id="setVars" style="display:none" action="#" method="get">
			Target host: <input value="" type="text" style="width: 30%; height: 2em; margin: 20px" id="i_reqHost" name="host"/>
			<input type="submit" value="Try again"/>
		</form>
	</body>
</html>
