<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<script src="/js/allfuncs.js" charset="utf-8"></script>
		<script charset="utf-8">
			registerWinOnLoad(function () {
				var currOrigin = getCurrOrigin();
				var reqOrigin = getPar("reqOrigin");
				if (reqOrigin) { reqOrigin = decodeURIComponent(reqOrigin); }
				var loggedIn = Boolean(reqOrigin);
				if (! loggedIn) {
					// not the callback from login
					// TODO: check if logged in by attempting to fetch secret and looking at the status code
					reqOrigin = getReqOrigin();
					if (! reqOrigin || reqOrigin == currOrigin) {
						if (! reqOrigin) {
							logToPage('Cannot determine target origin! Give the target host');
						} else {
							logToPage('Target is the same as current origin! Give a different one');
						}
						document.getElementById('i_reqHost').value = window.location.host; // default to current
						document.getElementById('setVars').style = "";
						return;
					}

					logToConsole('Target origin is ' + reqOrigin);
					logToConsole('Current origin is ' + currOrigin);

					// Login to target
					logToConsole('Logging in to target');
					// keep URL parameters except for host, hostname and port
					var origPars = filterPars(['host', 'hostname', 'port']);
					var callbackUrl = currOrigin + window.location.pathname +
						'?reqOrigin=' + encodeURIComponent(reqOrigin) +
						(origPars ? '&' + origPars : '');
					window.location.replace(reqOrigin + '/login?goto=' +
						encodeURIComponent(callbackUrl));
					return;
				}

				var target = reqOrigin + '/secret/secret.';
				logToPage('Target is ' + target + 'txt');
			  getData(target + 'txt', window.location.href, null, ['XHR', 'Iframe', 'Object']);
			  //DEBUG getData(target + 'txt', window.location.href, null, ['XHR']);
			  //DEBUG getData(target + 'txt', window.location.href, null, ['Iframe']);
			  //DEBUG getData(target + 'txt', window.location.href, null, ['Object']);
				logToPage('Target is ' + target + 'png');
			  getData(target + 'png', window.location.href, null, ['2DCanvas', 'BitmapCanvas']);
			  //DEBUG getData(target + 'png', window.location.href, null, ['2DCanvas']);
			  //DEBUG getData(target + 'png', window.location.href, null, ['BitmapCanvas']);
			});
		</script>
	</head>
	<body>
		<div id="log" style="margin-top: 20px; margin-bottom: 20px"></div>
		<div id="errLog" style="margin-top: 20px; margin-bottom: 20px"></div>
		<form id="setVars" style="display:none" action="#" method="get">
			Target host: <input value="" type="text" style="width: 30%; height: 2em; margin: 20px" id="i_reqHost" name="host"/>
			<input type="submit" value="Try again"/>
		</form>
	</body>
</html>
