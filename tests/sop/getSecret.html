<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<script src="/js/allfuncs.js" charset="utf-8"></script>
		<script charset="utf-8">
			registerWinOnLoad(function () {
				var reqOrigin = getPar("reqOrigin");
				var currOrigin = getCurrOrigin();
				var loggedIn = Boolean(reqOrigin);
				if (! loggedIn) {
					// not the callback from login.html
					reqOrigin = getReqOrigin();
					if (! reqOrigin) {
						logToConsole('Cannot determine target origin, nothing to do');
						return;
					}

					logToConsole('Target origin is ' + reqOrigin);
					logToConsole('Current origin is ' + currOrigin);

					// Login to target
					logToConsole('Logging in to target');
					// keep URL parameters except for host, hostname and port
					var origPars = filterPars(['host', 'hostname', 'port']);
					var callbackUrl = currOrigin + window.location.pathname +
						'?reqOrigin=' + reqOrigin + (origPars ? '&' + origPars : '');
					window.location.replace(reqOrigin + getCurrDir() +
						'login.html?goto=' +
						encodeURIComponent(callbackUrl));
				}

				var target = reqOrigin + '/secret/secret.txt';
				logToPage('Target is ' + target);

				function getLoadURL(origin, creds, post) {
					return 'getData.html?reqURL=' + encodeURIComponent(target +
						'?origin=' + origin +
						'&creds=' +
						(creds ? '1' : '0')) +
						'&post=' + (post ? '1' : '0');
				};

				var frameStyle = 'width: 100%; height: 5em; border: none;';
				// create iFrames for all combinations of CORS headers
				// GET
				addElement('iframe',{style: frameStyle, src: getLoadURL('*', true, false)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('*', false, false)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('%%ECHO%%', true, false)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('%%ECHO%%', false, false)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('', false, false)});
				// POST
				addElement('iframe',{style: frameStyle, src: getLoadURL('*', true, true)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('*', false, true)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('%%ECHO%%', true, true)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('%%ECHO%%', false, true)});
				addElement('iframe',{style: frameStyle, src: getLoadURL('', false, true)});
			});
		</script>
	</head>
	<body>
	</body>
</html>
